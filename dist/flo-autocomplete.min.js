!function(e){var t;e.fn.getSelection=function(){var e,t,n,o,c,l=this[0],s=0,a=0;return"number"==typeof l.selectionStart&&"number"==typeof l.selectionEnd?(s=l.selectionStart,a=l.selectionEnd):(t=document.selection.createRange())&&t.parentElement()==l&&(o=l.value.length,e=l.value.replace(/\r\n/g,"\n"),(n=l.createTextRange()).moveToBookmark(t.getBookmark()),(c=l.createTextRange()).collapse(!1),n.compareEndPoints("StartToEnd",c)>-1?s=a=o:(s=-n.moveStart("character",-o),s+=e.slice(0,s).split("\n").length-1,n.compareEndPoints("EndToEnd",c)>-1?a=o:(a=-n.moveEnd("character",-o),a+=e.slice(0,a).split("\n").length-1))),{start:s,end:a,length:a-s,text:l.value.substring(s,a)}},e.fn.replaceSelection=function(e){var t=this[0];if("number"==typeof t.selectionStart&&"number"==typeof t.selectionEnd){var n=t.value,o=t.selectionStart,c=t.selectionEnd;t.value=n.substring(0,o)+e+n.substring(c,n.length),t.selectionStart=t.selectionEnd=o+e.length}else if(document.selection&&document.selection.createRange){t.focus();var l=document.selection.createRange();l.text=e,l.collapse(!1),l.select()}return this},e.fn.insertAtCaretPos=function(e){var n,o,c,l,s,a,r,i=this.jquery?this[0]:this,u=0,g=0,m=null==i.scrollTop?0:i.scrollTop;if(i.focus(),document.selection&&"number"!=typeof i.selectionStart&&(null!=i.value.match(/\n/g)&&(g=i.value.match(/\n/g).length),r=parseInt(t),g>0))for(var h=0;h<=g;h++){var f=i.value.indexOf("\n",c);-1!=f&&f<=r&&(c=f+1,r-=1,u++)}return t=parseInt(t),i.onmouseup=function(){document.selection&&"number"!=typeof i.selectionStart&&(i.focus(),l=document.selection.createRange(),s=i.createTextRange(),a=s.duplicate(),s.moveToBookmark(l.getBookmark()),a.setEndPoint("EndToStart",s),t=a.text.length)},document.selection&&"number"!=typeof i.selectionStart?(0!=(l=document.selection.createRange()).text.length||(s=i.createTextRange(),textLength=s.text.length,a=s.duplicate(),s.moveToBookmark(l.getBookmark()),a.setEndPoint("EndToStart",s),n=a.text.length,t>0&&0==n?(u=t-u,s.move("character",u),s.select(),l=document.selection.createRange(),t+=e.length):t>=0||0!=textLength?t>=0||0!=n?!(t>=0)&&n>0?(s.move("character",0),document.selection.empty(),s.select(),l=document.selection.createRange(),t=n+e.length):t>=0&&t==textLength?(0!=textLength?(s.move("character",textLength),s.select()):s.move("character",0),l=document.selection.createRange(),t=e.length+textLength):t>=0&&0!=n&&t>=n?(u=t-n,s.move("character",u),document.selection.empty(),s.select(),l=document.selection.createRange(),t+=e.length):t>=0&&0!=n&&t<n?(s.move("character",0),document.selection.empty(),s.select(),l=document.selection.createRange(),t+=e.length):(document.selection.empty(),s.select(),l=document.selection.createRange(),t+=e.length):(s.move("character",textLength),s.select(),l=document.selection.createRange(),t=e.length+textLength):(l=document.selection.createRange(),t=e.length+textLength),l.text=e,i.focus()),this):"number"==typeof i.selectionStart&&i.selectionStart==i.selectionEnd?(c=i.selectionStart+e.length,n=i.selectionStart,o=i.selectionEnd,i.value=i.value.substr(0,n)+e+i.value.substr(o),i.setSelectionRange(c,c),i.scrollTop=m,this):this},e.fn.setSelection=function(e,t){e=parseInt(e),t=parseInt(t);var n=this.jquery?this[0]:this;if(n.focus(),"number"!=typeof n.selectionStart&&(re=n.createTextRange(),re.text.length<t&&(t=re.text.length+1)),t<e)return this;if(document.selection){var o=0,c=0,l=0,s=0;if("number"!=typeof n.selectionStart)return re.collapse(!0),re.moveEnd("character",t),re.moveStart("character",e),re.select(),this;if("number"==typeof n.selectionStart){if(null!=n.value.match(/\n/g)&&(o=n.value.match(/\n/g).length),o>0)for(var a=0;a<=o;a++){var r=n.value.indexOf("\n",l);if(-1!=r&&r<e)l=r+1,s=++c;else if(-1!=r&&r>=e&&r<=t){if(r==e+1){c--,s--,l=r+1;continue}l=r+1,s++}else a=o}return e+=c,t+=s,n.selectionStart=e,n.selectionEnd=t,this}return this}return n.selectionStart?(n.focus(),n.selectionStart=e,n.selectionEnd=t,this):void 0},navigator.userAgent.match(/opera/i)&&e(document).keypress(function(t){e.floautocompleteFocused&&(e.floautocompleteFocused.focus(),e.floautocompleteFocused=null,t.preventDefault(),t.stopPropagation())}),e.floautocompleteKeys={UNKNOWN:0,SHIFT:16,CTRL:17,ALT:18,LEFT:37,UP:38,RIGHT:39,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},e.floautocompleteFocused=null,e.fn.floautocomplete=function(t,n){return this.each(function(){e.makeSuggest(this,t,n)})},e.fn.floautocomplete.defaults={delimiters:"\n ",minChunkSize:1,cycleOnTab:!0,autoComplete:!0,endingSymbols:". ",stopSuggestionKeys:[e.floautocompleteKeys.RETURN],ignoreCase:!0},e.makeSuggest=function(t,n,o){o=e.extend({},e.fn.floautocomplete.defaults,o);var c=e.floautocompleteKeys,l=e(t);l.suggests=n,l.options=o;var s="-1";return l.getChunk=function(){var e,t,n,o="\n,.".split(","),c=this.val().substr(0,this.getSelection().start),l=-1;for(e=0;e<o.length;e++)t=o[e],(n=c.lastIndexOf(t))>l&&(l=n,s=t);return l<0?c:"\n"==s?c.substr(l+1):c.substr(l+2)},l.getCompletion=function(e){var t,n,o=this.getChunk(),c=this.getSelection().text,s=this.suggests,a=!1,r=null,i="";for(t=0;t<s.length;t++)if(n=s[t],l.options.ignoreCase&&(i=n,n=n.toLowerCase(),o=o.toLowerCase()),0===n.indexOf(o)){if(!e)return i.substr(o.length);if(o+c===n)a=!0;else{if(a)return i.substr(o.length);null===r&&(r=i)}}return e&&r?r.substr(o.length):null},l.updateSelection=function(e){if(e){var t=l.getSelection().start,n=t+e.length;""===l.getSelection().text?(l.val().length===t&&l.setCaretPos(t+1e4),l.insertAtCaretPos(e)):l.replaceSelection(e),l.setSelection(t,n)}},l.unbind("keydown.floautocomplete").bind("keydown.floautocomplete",function(t){if(t.keyCode===c.TAB&&l.options.cycleOnTab)return l.getChunk().length>=l.options.minChunkSize&&l.updateSelection(l.getCompletion(!0)),t.preventDefault(),t.stopPropagation(),l.focus(),e.floautocompleteFocused=this,!1;if(l.getSelection().length&&-1!==e.inArray(t.keyCode,l.options.stopSuggestionKeys)){var n=l.getSelection().end+l.options.endingSymbols.length,o=l.getSelection().text+l.options.endingSymbols;return l.replaceSelection(o),l.setSelection(n,n),t.preventDefault(),t.stopPropagation(),this.focus(),e.floautocompleteFocused=this,!1}}),l.unbind("keyup.floautocomplete").bind("keyup.floautocomplete",function(e){var t=e.altKey||e.metaKey||e.ctrlKey,n=t||e.shiftKey;switch(e.keyCode){case c.UNKNOWN:case c.SHIFT:case c.CTRL:case c.ALT:case c.RETURN:break;case c.TAB:if(!n&&l.options.cycleOnTab)break;case c.ESC:case c.BACKSPACE:case c.DEL:case c.UP:case c.DOWN:case c.LEFT:case c.RIGHT:!n&&l.options.autoComplete&&l.replaceSelection("");break;default:if(!t&&l.options.autoComplete)l.getChunk().length>=l.options.minChunkSize&&l.updateSelection(l.getCompletion(!1))}}),l}}(jQuery);